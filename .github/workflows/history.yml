name: Show Action History

on:
  workflow_dispatch:  # esecuzione manuale

jobs:
  show-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show recent workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Recent workflow runs for this repository:"
          gh run list --limit 10
          
      - name: Show last run details for each workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“œ Getting list of workflows..."
          workflows=$(gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[].name')

          for name in $workflows; do
            echo ""
            echo "ğŸ” Workflow: $name"

            # Get the workflow ID from the name
            id=$(gh api repos/${{ github.repository }}/actions/workflows --jq ".workflows[] | select(.name==\"$name\") | .id")

            if [ -z "$id" ]; then
              echo "âŒ Unable to find workflow ID for $name"
              continue
            fi

            # Get latest run details
            latest_run=$(gh api repos/${{ github.repository }}/actions/workflows/$id/runs?per_page=1 --jq '.workflow_runs[0]')
            
            if [ "$latest_run" == "null" ]; then
              echo "âš ï¸ No runs found for this workflow."
              continue
            fi

            echo "ğŸ“„ ID:     $(echo "$latest_run" | jq -r '.id')"
            echo "ğŸ“¦ Name:   $(echo "$latest_run" | jq -r '.name')"
            echo "ğŸ”— URL:    $(echo "$latest_run" | jq -r '.html_url')"
            echo "ğŸ§ª Status: $(echo "$latest_run" | jq -r '.status')"
            echo "âœ… Result: $(echo "$latest_run" | jq -r '.conclusion')"
            echo "ğŸŒ¿ Branch: $(echo "$latest_run" | jq -r '.head_branch')"
            echo "ğŸ•’ Created: $(echo "$latest_run" | jq -r '.created_at')"
          done
